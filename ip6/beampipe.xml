<?xml version="1.0" encoding="UTF-8"?>
<lccdd>
  <define>
    <constant name="BeampipeUpstreamStraightLength"   value=" 800.0 * mm"/>
    <constant name="BeampipeDownstreamStraightLength" value=" 670.0 * mm"/>
    <constant name="BeampipeDownstreamTotalLength"    value="5040.0 * mm"/>

    <constant name="BeampipeDownstreamExpansionAngle"   value="2.0 * abs(CrossingAngle)"/>

    <!-- FIXME avoid overlap with TrackerEndcapP_Outer_layer3 by moving flange 40 mm in z -->
    <constant name="BeampipeDownstreamFlange1_zmin"     value="1240.00 * mm"/>
    <constant name="BeampipeDownstreamFlange1Length"    value="  40.0 * mm"/>
    <constant name="BeampipeDownstreamFlange1Thickness" value="  30.0 * mm"/>
    <!-- FIXME avoid overlap with TrackerEndcapP_Outer_layer3 by decreasing OD by 1 mm -->
    <constant name="BeampipeDownstreamODatFlange1"      value="(BeampipeDownstreamFlange1_zmin - BeampipeDownstreamStraightLength) * tan(BeampipeDownstreamExpansionAngle) - 1.0 * mm"/>

    <constant name="BeampipeDownstreamFlange2_zmin"     value="5000.0 * mm"/>
    <constant name="BeampipeDownstreamFlange2Length"    value="  40.0 * mm"/>
    <constant name="BeampipeDownstreamFlange2Thickness" value="  39.0 * mm"/>
    <constant name="BeampipeDownstreamODatFlange2"      value="(BeampipeDownstreamFlange2_zmin - BeampipeDownstreamStraightLength) * tan(BeampipeDownstreamExpansionAngle)"/>
  </define>

  <display>
  </display>

  <detectors>

    <detector id="BeamPipe_ID" name="BeamPipe" type="IP6BeamPipe" vis="BeamPipeVis"> 
      <beampipe/>
      <IP_pipe
        OD="BeampipeOD"
        wall_thickness="0.757*mm"
        gold_thickness="5*um"
        crossing_angle="CrossingAngle"
        upstream_straight_length="BeampipeUpstreamStraightLength"
        downstream_straight_length="BeampipeDownstreamStraightLength"
      />

      <comment> For upstream beampipe, we subtract the vacuum from the matter </comment>
      <upstream reflect="true"
                place_vacuum="true"
                subtract_vacuum="true"
                subtract_matter="false">
        <outgoing_lepton thickness="2.0*mm">
          <zplane z="BeampipeUpstreamStraightLength" OD="BeampipeOD"/>
          <zplane z="2690.95 * mm" OD="85.616 * mm"/>
          <zplane z="4560.17 * mm" OD="99.20 * mm"/>
        </outgoing_lepton>
        <incoming_hadron thickness="1.65*mm"
                         crossing_angle="CrossingAngle">
          <!-- avoid overlap with IP beampipe by starting slightly displaced -->
          <zplane z="BeampipeUpstreamStraightLength + 0.5 * max(BeampipeOD, 24.714 * mm) * tan(abs(CrossingAngle))" OD="24.714 * mm"/>
          <zplane z="2690.95 * mm" OD="24.714 * mm"/>
          <zplane z="2710.75 * mm" OD="31.75 * mm"/>
          <zplane z="2890.35 * mm" OD="31.75 * mm"/>
          <zplane z="2940.35 * mm" OD="44.45 * mm"/>
          <zplane z="4490.35 * mm" OD="44.45 * mm"/>
        </incoming_hadron>
      </upstream>

      <comment> For downstream beampipe (where on is inside the vacuum of the other), we subtract the matter from the vacuum, and subtract an additional pipe to create the angled cutout</comment>
      <downstream reflect="false"
                  place_vacuum="true"
                  subtract_vacuum="false"
                  subtract_matter="true">
        <incoming_lepton thickness="1.0*mm">
          <zplane z="BeampipeDownstreamStraightLength" OD="BeampipeOD"/>
          <zplane z="BeampipeDownstreamTotalLength" OD="BeampipeOD"/>
        </incoming_lepton>
        <outgoing_hadron thickness="4.0*mm"
                         axis_intersection="BeampipeDownstreamStraightLength"
                         crossing_angle="CrossingAngle">
          <!-- avoid overlap with IP beampipe by starting slightly displaced -->
          <zplane z="BeampipeDownstreamStraightLength + 0.5 * BeampipeOD * tan(abs(CrossingAngle))"
                  OD="BeampipeOD"/>
          <zplane z="BeampipeDownstreamFlange1_zmin - 0.1 * mm"
                  OD="BeampipeDownstreamODatFlange1"/>
          <zplane z="BeampipeDownstreamFlange1_zmin"
                  OD="BeampipeDownstreamODatFlange1 + 2.0 * BeampipeDownstreamFlange1Thickness"
                  extra_thickness="BeampipeDownstreamFlange1Thickness"/>
          <zplane z="BeampipeDownstreamFlange1_zmin + BeampipeDownstreamFlange1Length"
                  OD="BeampipeDownstreamODatFlange1 + 2.0 * BeampipeDownstreamFlange1Thickness"
                  extra_thickness="BeampipeDownstreamFlange1Thickness"/>
          <zplane z="BeampipeDownstreamFlange1_zmin + BeampipeDownstreamFlange1Length + 0.1 * mm"
                  OD="BeampipeDownstreamODatFlange1"/>
          <zplane z="BeampipeDownstreamFlange2_zmin - 0.1 * mm" 
                  OD="BeampipeDownstreamODatFlange2"/>
          <zplane z="BeampipeDownstreamFlange2_zmin"
                  OD="BeampipeDownstreamODatFlange2 + 2.0 * BeampipeDownstreamFlange2Thickness"
                  extra_thickness="BeampipeDownstreamFlange2Thickness"/>
          <zplane z="BeampipeDownstreamFlange2_zmin + BeampipeDownstreamFlange2Length"
                  OD="BeampipeDownstreamODatFlange2 + 2.0 * BeampipeDownstreamFlange2Thickness"
                  extra_thickness="BeampipeDownstreamFlange2Thickness"/>
        </outgoing_hadron>
        <additional_subtraction thickness="4.0*mm"
                                crossing_angle="CrossingAngle">
          <!-- these are somewhat arbitrary to get the right hole shape -->
          <zplane z="BeampipeDownstreamStraightLength" OD="32. * mm"/>
          <zplane z="BeampipeDownstreamTotalLength" OD="120. * mm"/>
        </additional_subtraction>
      </downstream>
    </detector>

  </detectors>


</lccdd>
